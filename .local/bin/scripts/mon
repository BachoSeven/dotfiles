#!/bin/sh

# Francesco Minnocci 2020
# This takes care of my external monitor setup, mostly for non-interactive purposes.

# edit these on other systems
int="eDP-1"
ext1="DP-1"
ext1_class="$ext1"
ext2="HDMI-2"
ext2_class="HDMI-A-2"
card="card0"

usbC="/sys/class/drm/$card-$ext1_class/status"
hdmi="/sys/class/drm/$card-$ext2_class/status"

miscfixes() {
	sbg # redraw background
	dunstreload # reload dunst configuration
	remaps
	cqctl magic
}


toggle() {
	if grep -q "\bconnected" $usbC || grep -q "\bconnected" $hdmi; then
		external
	else
		laptop
	fi
}

external() {
	if grep -q "\bconnected" $usbC; then
		ext="$ext1"
		xrandr --output $int --off --output $ext --auto --dpi 144 && miscfixes
	elif grep -q "\bconnected" $hdmi; then
		ext="$ext2"
		xrandr --output $int --off --output $ext --mode 2560x1440 && miscfixes
	fi
}

laptop() {
	xrandr --output "$ext1" --off --output "$ext2" --off --output $int --auto --dpi 96 && miscfixes
}

multiple() {
	if grep -q "\bconnected" $usbC; then
		ext="$ext1"
		## If positioning laptop *to the right of* monitor
		# xrandr --output $int --auto --output $ext --primary --auto --dpi 108 --left-of $int && miscfixes
		## If positioning laptop *below* monitor
		xrandr --output $int --auto --pos 0x2160 --output $ext --primary --auto --dpi 108 --pos 0x0 && miscfixes
	elif grep -q "\bconnected" $hdmi; then
		ext="$ext2"
		## If positioning laptop *to the right of* monitor
		# xrandr --output $int --auto --output $ext --primary --mode 2560x1440 --left-of $int && miscfixes
		## If positioning laptop *below* monitor
		xrandr --output $int --auto --pos 0x1440 --output $ext --primary --mode 2560x1440 --pos 0x0 && miscfixes
	fi
}

main() {
	_name="$(basename "$0")"
	while getopts ":elmt" o; do
		case "${o}" in
			e) # External
				external ;;
			l) # Laptop
				laptop ;;
			m) # Multi
				multiple ;;
			t) # Toggle
				toggle ;;
			*)
				printf "Invalid option: -%s\n" "$OPTARG"
				printf "usage: ${_name} [-e|-m|-l]\n" && exit 1 ;;
		esac
	done
}

# The actual script starts here
main "$@"
